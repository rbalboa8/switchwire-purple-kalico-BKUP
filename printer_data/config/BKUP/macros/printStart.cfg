[gcode_macro PRINT_START]
gcode:
    # --- Parameters & Variables ---
    {% set BED_TEMP = params.BED_TEMP|float %}
    {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|float %}
    {% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|float %}
    {% set SOAK_TIME_MINUTES = 10 %}
    {% set SOAK_TIME_MS = SOAK_TIME_MINUTES * 60 * 1000 %}
    {% set manual_soak = printer["gcode_macro _SOAK_STATE_VARIABLES"].manual_soak_active %}

    # --- 0. Console Debug: Verify Slicer Parameters ---
    # This immediately tells you if the slicer passed the wrong temps
    M118 >>> PRINT_START Initialized
    M118 Target Bed: {BED_TEMP}C
    M118 Target Nozzle: {EXTRUDER_TEMP}C
    M118 Target Chamber: {CHAMBER_TEMP}C

    # --- 1. Initial Setup ---
    status_off
    G90 ; Absolute positioning
    M220 S100 ; Reset Feedrate
    M221 S100 ; Reset Flowrate
    G92 E0 ; Reset Extruder
    M118 System reset complete (G90/M220/M221).

    # --- 2. Mechanical Gantry Align (Optional) ---
    # MECHANICAL_GANTRY_CALIBRATION 
    # M118 >>> Mechanical Gantry Calibration Complete

    # --- 3. Initial Homing (MANDATORY) ---
    # We REMOVE the "if" statement. We simply home.
    # This guarantees that no matter what happened before this line 
    # (crashes, alignments, manual moves), the printer is synced.
    M117 Homing...
    status_homing
    M118 Homing all axes (G28)...
    G28

    # Move to center/safe Z for heating
    G0 X110 Y110 Z150 F10000 

    # --- 4. Bed Heating & Soaking (Nozzle Cold) ---
    status_heating
    M117 Heating Bed...
    M118 >>> Heating Bed to {BED_TEMP}C...
    M140 S{BED_TEMP} ; Set bed temp

    # Wait for bed to reach temp
    M190 S{BED_TEMP}
    M118 Bed temp reached.

    # Chamber Soak Logic
    {% if CHAMBER_TEMP > 0 %}
        BENTO_ON
        SET_LED_EFFECT EFFECT=status_chamber_heating 
        
        {% if manual_soak %}
            M118 !!! Manual soak detected. Skipping timer. !!!
            M117 Manual soak detected. Verifying...
            TEMPERATURE_WAIT SENSOR=chamber MINIMUM={CHAMBER_TEMP}
            M118 Chamber temp confirmed (Manual Mode).
            SET_GCODE_VARIABLE MACRO=_SOAK_STATE_VARIABLES VARIABLE=manual_soak_active VALUE=False 
        {% else %}
            M118 Waiting for Chamber: {CHAMBER_TEMP}C...
            M117 Waiting for Chamber: {CHAMBER_TEMP}C
            TEMPERATURE_WAIT SENSOR=chamber MINIMUM={CHAMBER_TEMP}
            
            M118 Chamber target reached. Starting {SOAK_TIME_MINUTES} min soak...
            M117 Soaking for {SOAK_TIME_MINUTES} min...
            G4 P{SOAK_TIME_MS}
            M118 >>> Soak complete.
            M117 Soak complete.
        {% endif %}
    {% else %}
        # PLA/Open Mode
        M118 No chamber temp set. Skipping soak.
        BENTO_OFF
        status_printing 
    {% endif %}

    # --- 5. Meshing (Nozzle Cold) ---
    M118 >>> Starting Adaptive Mesh (Nozzle Cold)...
    M117 Generating Mesh...
    status_meshing
    BED_MESH_CLEAR
    
    # Optional: Re-home Z if you suspect thermal expansion shifted the switch/probe significantly
    # M118 Re-homing Z for accuracy...
    # G28 Z 
    
    BED_MESH_CALIBRATE PROFILE=default ADAPTIVE=1
    M118 Mesh generated successfully.

    # --- 6. Final Heating (Hotend) ---
    # Move to purge area or Safe Z
    G0 X0 Y0 Z20 F10000
    
    M118 >>> Final Heating: Nozzle to {EXTRUDER_TEMP}C...
    M117 Heating Nozzle to {EXTRUDER_TEMP}C...
    status_heating
    M109 S{EXTRUDER_TEMP} ; Heat nozzle and wait
    M118 Nozzle temp reached.

    # --- 7. Final Prep ---
    {% if CHAMBER_TEMP > 0 %}
        SET_LED_EFFECT EFFECT=printing
    {% endif %}
    
    SKEW_PROFILE LOAD=Calilantern
    GET_CURRENT_SKEW
    M118 Skew Profile 'Calilantern' Loaded.
    
    status_printing
    M118 Purging nozzle...
    M117 Purging...
    VORON_PURGE
    
    M118 >>> PRINT_START COMPLETE. Handing over to Slicer.
    M117 Print Starting!
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=10