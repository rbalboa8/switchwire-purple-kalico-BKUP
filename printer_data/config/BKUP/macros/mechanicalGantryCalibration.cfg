[gcode_macro MECHANICAL_GANTRY_CALIBRATION]
gcode:
    {% set my_current = 0.12 %} ; Current to use while "crashing" (Amps) - Adjust if too weak to lift gantry. if to weak try 0.15->0.2
    {% set old_current = printer.configfile.settings['tmc2209 stepper_x'].run_current %} ; Auto-detect your normal current
    # NOTE: If you use tmc2209, keep as is. If using tmc5160, change 'tmc2209' to 'tmc5160' above.

    M117 Calibrating Gantry...
    
    # 1. Home first to ensure we know roughly where we are (so we don't smash the bed going up)
    {% if not 'xyz' in printer.toolhead.homed_axes %}
        G28
    {% endif %}

    # 2. Move to the center and near the top (adjust Z max to be slightly less than your max_z)
    G90
    G0 X110 Z200 F10000 

    # 3. Lower motor current to safe levels
    # Note: We must lower BOTH X and Z steppers because CoreXZ uses both for Z movement
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={my_current}
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={my_current}

    # 4. The "Crash" - Move Z up past the physical limit
    # We move slowly (F1000) relative (G91) by 10mm more than should be needed
    G91
    G1 Z30 F1000 
    
    # 5. Move back down slightly to release tension
    G1 Z-10 F1000
    G90

    # 6. Restore High Currents
    SET_TMC_CURRENT STEPPER=stepper_x CURRENT={old_current}
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={old_current}

    # 7. Re-Home is MANDATORY (we lost steps during the crash)
    M117 Re-homing...
    G28
    M117 Gantry Squaring Done.