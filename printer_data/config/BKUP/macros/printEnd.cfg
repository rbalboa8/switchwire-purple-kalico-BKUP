[gcode_macro PRINT_END]
gcode:
    # --- 1. Variables & Safety Checks ---
    {% set th = printer.toolhead %}
    
    # Calculate a safe Z move (Lift 10mm, but clamp to max Z)
    {% set current_z = th.position.z %}
    {% set max_z = th.axis_maximum.z %}
    {% set z_hop = 10 %}
    {% set safe_z_target = [current_z + z_hop, max_z]|min %}
    
    # Calculate "Present Print" coordinates (Park Bed Front / Nozzle Rear)
    {% set park_x = th.axis_maximum.x - 2 %}
    {% set park_y = th.axis_maximum.y - 2 %}

    # --- 2. Completion Status ---
    M400                 ; Wait for buffer to clear
    M117 Print Complete!
    M118 >>> PRINT COMPLETE.
    status_part_ready    ; LED status

    # --- 3. Safety Retract & Z-Hop ---
    G92 E0               ; Zero extruder
    G1 E-1.0 F3600       ; Retract 1mm to prevent oozing
    G90                  ; Absolute Positioning
    
    # Move Z up to safe height
    G0 Z{safe_z_target} F3000
    M118 Z-Hopped to {safe_z_target}mm.

    # --- 4. Park & Present ---
    # Move Nozzle to back right, bringing Bed to front
    M117 Parking...
    G0 X{park_x} Y{park_y} F15000
    M118 Parking Toolhead at X{park_x} Y{park_y}.

    # --- 5. Shutdown Systems ---
    M117 Cooling down...
    M104 S0 ; Turn off hotend
    M140 S0 ; Turn off bed
    M106 S0 ; Turn off part cooling fan
    M118 Heaters and Fan disabled.
    
    # --- 6. Air Filter Logic (Smart) ---
    # M117 Scrubbing Air (10m)
    # M118 Starting 10min Bento Post-Scrub...
    # UPDATE_DELAYED_GCODE ID=shutdown_bento DURATION=600 ; 600 seconds = 10 mins
    
    # --- 7. Final Cleanup (Verbose) ---
    # Skew
    SET_SKEW CLEAR=1
    M117 Skew Cleared
    M118 >>> Skew Profile Cleared.
    
    # Pressure Advance
    SET_PRESSURE_ADVANCE ADVANCE=0.0
    M117 PA Cleared
    M118 >>> Pressure Advance Reset to 0.0.

    # Bed Mesh
    BED_MESH_CLEAR
    M117 Mesh Cleared
    M118 >>> Bed Mesh Cleared.

    # --- 8. Motor Disable ---
    M84 X Y E ; Disable XY and Extruder. Keep Z enabled.
    
    M117 Safe to remove.
    M118 >>> Systems Shutdown. Safe to remove print.