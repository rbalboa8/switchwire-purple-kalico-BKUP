# ======================================================================
#  MACRO 1: VARIABLES AND STORAGE
# ======================================================================
[gcode_macro _DRIFT_TEST_VARS]
variable_is_active: False
variable_target_temp: 0
variable_duration_min: 0
variable_interval_sec: 60
variable_current_iter: 0
gcode:
    # This macro is just for storage, no code needed here.

# ======================================================================
#  MACRO 2: START COMMAND (USER FACING)
# ======================================================================

[gcode_macro START_DRIFT_TEST]
description: Starts the test with debug output. Usage: START_DRIFT_TEST BED_TEMP=100 DURATION=30
gcode:
    {% set bed_temp = params.BED_TEMP|default(60)|int %}
    {% set duration = params.DURATION|default(30)|int %}
    
    # 1. Console Debug
    M118 DEBUG: Initializing Test...
    M118 DEBUG: Target Bed={bed_temp}C, Duration={duration}min
    
    # 2. Reset Variables
    SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=is_active VALUE=True
    SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=target_temp VALUE={bed_temp}
    SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=duration_min VALUE={duration}
    SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=current_iter VALUE=0
    
    # 3. Machine Prep
    M118 DEBUG: Homing and moving to park position...
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}
    G90
    G0 X109 Y89 Z15 F6000
    
    # 4. Heat
    M118 DEBUG: Heaters on.
    M140 S{bed_temp}
    M104 S150
    
    # 5. Print Data Header
    M118 DATA_START,Time_Min,Bed_Temp,Probe_Z
    
    # 6. Trigger Loop
    M118 DEBUG: Triggering loop timer (1 sec delay)...
    UPDATE_DELAYED_GCODE ID=_DRIFT_SAMPLE_LOOP DURATION=1


# ======================================================================
#  MACRO 3: THE LOOP (DELAYED GCODE)
# ======================================================================
[delayed_gcode _DRIFT_SAMPLE_LOOP]
gcode:
    # 1. Access the variables explicitly
    {% set vars = printer %}
    
    # 2. Debug: Prove we can read them
    # M118 DEBUG: Loop Running. Active={vars.is_active} Iter={vars.current_iter}
    
    {% if vars.is_active %}
        {% if vars.current_iter <= vars.duration_min %}
            # --- ACTION BLOCK ---
            
            # Move down to probe
            PROBE samples=3
            
            # Log Data
            _LOG_DRIFT_DATA
            
            # Move back up to soak
            G0 Z15 F6000
            
            # Increment Counter
            {% set next_iter = vars.current_iter + 1 %}
            SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=current_iter VALUE={next_iter}
            
            # Schedule Next Run
            M118 DEBUG: Scheduling next cycle in {vars.interval_sec}s...
            UPDATE_DELAYED_GCODE ID=_DRIFT_SAMPLE_LOOP DURATION={vars.interval_sec}
            
        {% else %}
            M118 DEBUG: Duration exceeded. Stopping.
            STOP_DRIFT_TEST
        {% endif %}
        
    {% else %}
        M118 DEBUG: Test is NOT active. Loop aborting.
    {% endif %}

# ======================================================================
#  MACRO 4: DATA LOGGING
# ======================================================================
[gcode_macro _LOG_DRIFT_DATA]
gcode:
    {% set vars = printer %}
    {% set time_min = vars.current_iter %}
    {% set bed_temp = printer.heater_bed.temperature %}
    # We use 'last_probe_position' (index 2 is Z)
    {% set z_val = printer.probe.last_probe_position[1] %}
    
    # Output raw CSV line
    M118 DATA,{time_min},{bed_temp},{z_val}

# ======================================================================
#  MACRO 5: STOP/CLEANUP
# ======================================================================
[gcode_macro MACRO_STOP_CLEANUP]
gcode:
    SET_GCODE_VARIABLE MACRO=_DRIFT_TEST_VARS VARIABLE=is_active VALUE=False
    M118 DATA_END
    M118 DEBUG: Test manually stopped or finished.
    TURN_OFF_HEATERS