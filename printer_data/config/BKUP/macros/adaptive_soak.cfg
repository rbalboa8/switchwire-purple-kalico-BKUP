[gcode_macro _ADAPTIVE_SOAK_VARS]
variable_target_temp: 0
variable_tolerance: 0.005
variable_stable_streak: 0
variable_last_z: -999.999
variable_max_retries: 30
variable_current_retry: 0
gcode:
    # Variable storage only

[gcode_macro CHECK_PROBE_DRIFT]
description: Repeatedly probes until the drift is under tolerance.
gcode:
    {% set tolerance = params.TOLERANCE|default(0.005)|float %}
    {% set max_retries = params.MAX_RETRIES|default(30)|int %}
    {% set retry_number = params.RETRY_NUMBER|default(0)|int %}
    
    # 1. Probe the bed
    PROBE samples=3
    
    # 2. Check Stability
    _EVALUATE_PROBE_DRIFT TOLERANCE={tolerance} MAX_RETRIES={max_retries} RETRY_NUMBER={retry_number}

[gcode_macro _EVALUATE_PROBE_DRIFT]
gcode:
    {% set tolerance = params.TOLERANCE|float %}
    {% set max_retries = params.MAX_RETRIES|int %}
    {% set retry_number = params.RETRY_NUMBER|int %}
    
    {% set vars = printer %}
    {% set current_z = printer.probe.last_probe_position[1] %}
    {% set last_z = vars.last_z %}
    
    # Initialize if first run
    {% if last_z == -999.999 %}
        M118 Baseline Z: {current_z}. Heating...
        SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=last_z VALUE={current_z}
        
        # Wait 60 seconds
        G0 Z15 F6000
        G4 P60000
        
        # Recursive Call
        CHECK_PROBE_DRIFT TOLERANCE={tolerance} MAX_RETRIES={max_retries} RETRY_NUMBER={retry_number + 1}
        
    {% else %}
        {% set drift = (current_z - last_z)|abs %}
        M118 Drift: {drift|round(4)} / Tol: {tolerance}
        
        # Update Last Z
        SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=last_z VALUE={current_z}
        
        # Stability Logic
        {% if drift < tolerance %}
            {% set new_streak = vars.stable_streak + 1 %}
            SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=stable_streak VALUE={new_streak}
            
            {% if new_streak >= 2 %}
                M118 Probe Stable! Proceeding...
                # Reset variables for next time
                SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=last_z VALUE=-999.999
                SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=stable_streak VALUE=0
                # Routine Ends here, allowing PRINT_START to continue
            {% else %}
                M118 Stable reading {new_streak}/2...
                G0 Z15 F6000
                G4 P60000
                CHECK_PROBE_DRIFT TOLERANCE={tolerance} MAX_RETRIES={max_retries} RETRY_NUMBER={retry_number + 1}
            {% endif %}
            
        {% else %}
            # Drift detected
            SET_GCODE_VARIABLE MACRO=_ADAPTIVE_SOAK_VARS VARIABLE=stable_streak VALUE=0
            
            {% if retry_number >= max_retries %}
                M118 Stability Timeout! Proceeding with best effort.
            {% else %}
                M118 Drift detected. Waiting...
                G0 Z15 F6000
                G4 P60000
                CHECK_PROBE_DRIFT TOLERANCE={tolerance} MAX_RETRIES={max_retries} RETRY_NUMBER={retry_number + 1}
            {% endif %}
        {% endif %}
    {% endif %}